<?php  

/* 
 * the main menu for Hip Chat archive
 * hook_menu
 */
function hipchat_archive_menu() {
  $items = array();

  $items['hipchat-archive/%/%'] = array(
    'title' => 'Hip chat Archive',
    'description' => 'displays archives of Hip chat',
    'page callback' => '_hipchat_archive_get_data',
    'access callback' => TRUE,
    'page arguments' => array(1,2),
    'title' => 'Archives',
  );

  return $items;
}

/**
 * _hipchat_date_check
 * parameter = $date 
 * return = boolean
 * if the date is in the correct format and the month, day and year
 * are ints, then return true
 * Else return the de
 */
  function _hipchat_date_check($date){
   $exp = explode('-', $date);
   $defaultDate = date('Y-m-d');  
   $bool =  false;
   if (strpos('-', $date) !== false){
      $exp = explode('-', $date);
      $month = $exp[1];
      $day = $exp[2];
      $year = $exp[0];
      if ((intval($month) === 0) || (intval($day) === 0) || (intval($year) === 0)){
         $bool = checkdate($exp[1],$exp[2],$exp[0]);
      }
      else {
        $bool = true;  
      }
   }
   else {
      $bool = true;
 }
  return $bool;
 }
 
 /**
 * _hipchat_room_id_check
 * parameter = $url_room_id
 * checks if the room_id is a valid int
 */
 function _hipchat_room_id_check($url_room_id){
  $bool = false;
  if (intval($url_room_id) === 0){
     $bool = true;     
 }
   return $bool;
 }
 
/**
 * _hipchat_archive_get_data
 * parameter = $date 
 * if no parameter is given, the default would be today
 * The date of the format(yyyy-mm-dd) is sent to the apichat
 * service and chat history retrieved for that date
 */
function _hipchat_archive_get_data($date = NULL,$room_id=575239){
  //variable declaration
  $link = 'https://api.hipchat.com/v1/rooms/history?room_id='; 
  $output = '';
  $authToken = '&auth_token=f9f12e58a0df9ed77e14094a5eacb1';
  $time_zone = 'America/New_York';
  $format = 'json';
  $currDate = date('Y-m-d');
  $formattedData = '';
 
  //check room_id 
  //if null or is not int
  //make room_id default
  if ($url_room_id == Null || _hipchat_room_id_check($url_room_id)){
      $room_id = 575239;
      if (_hipchat_room_id_check($url_room_id)){
         drupal_set_message(t('Room id needs to be of type integer'), 'error');
        }
    } else {
      $room_id = $url_room_id;
    }

  //check date 
  //if the date clicked is either null or today's date
  //make the current date as today with next day as null
  //else the date clicked can only be less than the current date
   if (_hipchat_date_check($date) || $date == Null || $date >= $currDate){
      // $currDate = '2014-05-30';
      $date = $currDate;
      $nextDate ='';
      if (_hipchat_date_check($date)){
            drupal_set_message(t('Date must be a valid date'), 'error');
      }
      if ($date > $currDate) {
         drupal_set_message(t('Cannot retrieve data for date beyond today'), 'error');
       } 
     }
     else{
       $nextDate = date('Y-m-d', strtotime($date .' +1 day'));
     }
  
    $prevDate = date('Y-m-d', strtotime($date .' -1 day')); 
  
     //get history from api.hipchat.com for the parameters
    try {
       $chatData = file_get_contents($link.$room_id.'&date='.$date.'&timezone='.$time_zone.'&format='.$format.$authToken);
     }
    catch(Exception $e){
       drupal_set_message(t('Issue in retrieving the data. Message = %message, query=%query', 
       array('%message' =>$e->getMessage(),'%query' => $e->query_string)), 'error');
     } 
  
  //format the data 
    $formattedData = _hipchat_archive_format_data($prevDate,$date,$chatData,$nextDate);

  //return the formatted data
   return $formattedData;    
}  
  
/**
 * _hipchat_archive_format_data
 * parameter = $prevDate, $todayDate, $data, $nextDate
 * formats the data and returns the data in a table format
 * $prevDate,$nextDate are used for creating links
 * $todayDate is used for showing the user that the date on a 
 * page is for that date and hence not a link
 * $data is the chat history for the date selected
 */
function _hipchat_archive_format_data($prevDate,$todayDate,$data,$nextDate){
  //variable declaration
  $rows = array();
  $build =array();
  $prevLink = l(t($prevDate), 'hipchat-archive/'.$prevDate);
  $nextLink = l(t($nextDate), 'hipchat-archive/'.$nextDate);

  //get data from the 
  $output = drupal_json_decode($data);
   
  //create the header for the table
  $header = array('From','Message','Date');
  $result = $output['messages'];
  
  //put data into rows
  foreach($result as $key => $data) {
    $user = $data['from']['name'];
    if (isset($result[$key - 1])) {
      $pre_user = $result[$key - 1]['from']['name'];
    } else {
      $pre_user = '';
    }
    
    if ($user == $pre_user) {
      $user = '';
    }
    
    $rows[] = array(
      $user,
      $data['message'],
      $data['date'],
    ); 
  }

  //add dates as links in left, center and right positions
  $build['links'] = array(
   '#markup' => '<p style="text-align:left;">'.$prevLink.'
                    <span style="float:center;margin-left: 230px;">'
					   .$todayDate.'<span style="float:right;">'.$nextLink.'</p>'); 
  
  //add the header and rows as data to the table
  $build['data'] =  array(
     '#theme' => 'table',
	 '#header' => $header, 
	 '#rows' => $rows);
  
  //return formatted output
  return $build;
  }